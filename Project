- name: Create application directory
  file:
    path: "{{ deployment_directory }}"
    state: directory
    owner: "{{ runtime_user }}"
    group: "{{ runtime_group }}"
    mode: "{{ app_directory_permission }}"

- name: Download build artifacts from artifactory
  get_url:
    url: "{{ lightspeed_artifactory_build_artifacts_url }}/{{ artifacts_file_name }}"
    dest: "{{ deployment_directory }}/{{ artifacts_file_name }}"
    force: yes
    username: "{{ lightspeed_artifactory.username }}"
    password: "{{ lightspeed_artifactory.password }}"
    validate_certs: no
    mode: "0777"
    timeout: 3600
    force_basic_auth: yes
  register: artifacts_result
  until: artifacts_result.failed == False
  retries: 3
  delay: 5

- name: Extract build artifacts
  unarchive:
    src: "{{ deployment_directory }}/{{ artifacts_file_name }}"
    dest: "{{ deployment_directory }}"
    remote_src: yes

# >>> ADD THIS BLOCK RIGHT AFTER UNARCHIVE <<<

- name: Read list of DAGs to deploy
  slurp:
    src: "{{ deployment_directory }}/deploy_dags.txt"
  register: deploy_dags_content

- name: Set list of DAG files
  set_fact:
    dag_files: "{{ deploy_dags_content['content'] | b64decode | splitlines() }}"

- name: Copy selected DAG files
  copy:
    src: "{{ deployment_directory }}/dags/{{ item }}"
    dest: "{{ airflow_dags_directory }}/{{ item }}"
    owner: "{{ runtime_user }}"
    group: "{{ runtime_group }}"
    mode: '0644'
  loop: "{{ dag_files }}"
  when: item != ""

# <<< END OF NEW BLOCK >>>

# (rest of your existing tasks continue below if there are any)
